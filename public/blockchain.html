<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <script src="/bower_components/jquery/dist/jquery.js"></script>
  <script src="/bower_components/underscore/underscore.js"></script>
  <script src="/bower_components/d3/d3.min.js"></script>

  <link href='http://fonts.googleapis.com/css?family=Muli' rel='stylesheet' type='text/css'>
  <link href="stylesheets/live-blockchain.css" rel="stylesheet">


</head>
<body>
<div class="intro">
  <div class="largeType">Live from the Bitcoin block chain</div>
  <div class="smallType">This is the Bitcoin network in real time. Every day, the Bitcoin network processes upwards of $50 million. </div>
 
  <div id="unconfirmed-one"></div>
  <div id="confirmed-one"></div>
</div>
<div class="viz"></div>
 






  <script>
  var 
  columnLeft = 0, 
  columnTop = 0,
  horzSpace = 6, 
  vertSpace = 10,
  blockHeight = 18,
  pixelsPerBtc = 10,
  maxWidth = $(window).width() - 20,
  minWidth = 1,
  opacityDecayRate = 120000; // millis per opacity. 

  var enterColor = "#FFFDF3";
  var regularColor = "#D816AB";

  var txnConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  var txns = [];
  var hashToTxnIndex = {};

  txnConn.onopen = function (ev) {
    var req = {type: "new-transaction", block_chain: "bitcoin"};
    txnConn.send(JSON.stringify(req));
  };

  txnConn.onmessage = function (ev) {
    var x = JSON.parse(ev.data);
    if (x.payload.transaction) {
      // console.dir(x);
      update(x);
    }
  };

  txnConn.onclose = function (ev) {
    txnConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  };

  var blockConn = new WebSocket("wss://ws.chain.com/v2/notifications");


  blockConn.onopen = function (ev) {
    var req = {type: "new-block", block_chain: "bitcoin"};
    blockConn.send(JSON.stringify(req));
  };

  blockConn.onmessage = function (ev) {
    var x = JSON.parse(ev.data);
    if (x.payload.block) {
      updateBlock(x);
    }
  };

  blockConn.onclose = function (ev) {
    blockConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  };

  var updateBlock = function(block) {
    var confirmedTxns = block.payload.block.transaction_hashes;
    _.each(confirmedTxns, function(confirmedTxnHash) {
      console.dir("updating " + confirmedTxnHash)
      var idx = hashToTxnIndex[confirmedTxnHash];
      if (idx) {
        txns[idx].payload.transaction.confirmations = 1;
      }
    });
  };

  var getWidthFromSatoshis = function(satoshis) {
    var w = (satoshis / 1e8) * pixelsPerBtc;
    w = (w > maxWidth)? maxWidth : w;
    w = (w < minWidth)? minWidth : w;
    return w;
  }

  d3.select("#unconfirmed-one")
  .append("svg").attr("height", blockHeight).attr("width", 500)
  .append("rect")
  .attr("class", "unconfirmed")
  .attr("x", 0).attr("y", 0)
  .attr("width", pixelsPerBtc).attr("height", blockHeight);

  d3.select("#unconfirmed-one").select("svg")
  .append("text")
  .attr("x", pixelsPerBtc + 6)
  .attr("y", 0)
  .attr("dy", ".9em")
  .attr("class", "smallType")
  .text("1 bitcoin transaction, worth $300");




  d3.select("#confirmed-one")
  .append("div")
  .append("svg").attr("height", blockHeight).attr("width", 500)
  .append("rect")
  .attr("class", "confirmed")
  .attr("x", 0).attr("y", 0)
  .attr("width", pixelsPerBtc).attr("height", blockHeight);

  d3.select("#confirmed-one").select("svg")
  .append("text")
  .attr("x", pixelsPerBtc + 6)
  .attr("y", 0)
  .attr("dy", ".9em")
  .attr("class", "smallType")
  .text("1 bitcoin transaction, mined into a block");

  var svg = d3.select(".viz").append("svg")
              .attr("width", $(window).width())
              .attr("height", 10000);



  var draw = function(data) {
    svg.selectAll("rect")
    .data(data)
    .attr("class", function(d) {
      if (d.payload.transaction.confirmations > 0) {
        return "confirmed";
      } else {
        return "unconfirmed";
      }
    })
    .attr("fill-opacity", function(d, i) {
      if (d.payload.transaction.confirmations > 0) {
        return 1;
      }  else {
        var timeDiff = (new Date()) - d.pushedAt;
        var opacity = 1 - (timeDiff / opacityDecayRate);
        opacity = (opacity < 0)? 0 : opacity;
        return opacity;
      }
    })
    .enter()
    .append("rect")
    .attr("width", function(d, i) {
      return getWidthFromSatoshis(d.payload.transaction.amount);
    })
    .attr("height", blockHeight)
    .attr("x", function(d, i) {
      var width = getWidthFromSatoshis(d.payload.transaction.amount);
      var newColumnLeft = columnLeft + horzSpace + width;
      var value;
      if (newColumnLeft > $(window).width()) {
        value = 0;
        columnLeft = horzSpace + width;
        columnTop += blockHeight + vertSpace;
      } else {
        value = columnLeft;
        columnLeft = newColumnLeft;
      }
      return value;
    })
    .attr("y", function(d, i) {
      return columnTop;
    })
    .attr("fill", enterColor)
    .transition()
    .duration(750)
    .attr("fill", regularColor);
  };

  var _update = function(txn) {
    txn.pushedAt = new Date();
    var listIdx = txns.push(txn);
    hashToTxnIndex[txn.payload.transaction.hash] = listIdx - 1; 
    draw(txns);
  };
  var update = _.throttle(_update, 100); 

  </script>
</body>