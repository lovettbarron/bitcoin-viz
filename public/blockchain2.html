<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <script src="/bower_components/jquery/dist/jquery.js"></script>
  <script src="/bower_components/underscore/underscore.js"></script>
  <script src="/bower_components/d3/d3.min.js"></script>

  <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Lora:400,400italic' rel='stylesheet' type='text/css'>
  <link href="stylesheets/live-blockchain.css" rel="stylesheet">

  <script src="https://s3-us-west-2.amazonaws.com/cdn.thegrid.io/gss/v2.0.0/v2.0.0/gss.js"></script>

 <style type="text/gss">
    #intro-id[width] == 800;
    #intro-id[height] == #intro-id[intrinsic-height];
    #intro-id[center] == ::window[center];
  </style>



</head>
<body>
<div class="intro" id="intro-id">
  <div class="largeType">Live from the Bitcoin network</div>
  <div class="smallType"><p>The Bitcoin block chain is a distributed crypto-ledger that records Bitcoin transactions. Transactions from anywhere in the world appear on the network and are shared from peer to peer, before being eventually confirmed and included in a block on the block chain. We're visualizing transactions in real time as they appear on the network and get confirmed into blocks.  We were curious to see the dynamics in real time. How much bitcoin is being transacted? How frequently? We want to create intuitive, visual representations that bring the system to life.
  </p></div>
  <p></p>
  <div class="smallType">Stay tuned for more, and join the conversation with us on twitter @ideofutures.</div>


</div>
 

  <!-- <div id="unconfirmed-one"></div>
  <div id="confirmed-one"></div> -->
</div>
<div class="viz"></div>
 

<script>

  
  /* you can see what is going on in the engine with console.log(window.engine) */
  window.engine = new GSS(document);





  var 
  columnLeft = 0, 
  columnTop = 0,
  horzSpace = 6, 
  vertSpace = 10,
  blockHeight = 18,
  pixelsPerBtc = 10,
  maxWidth = $(window).width() - 20,
  minWidth = 1,
  opacityDecayRate = 120000; // millis per opacity. 

  var enterColor = "#FFFDF3";
  var regularColor = "#D816AB";

  var txnConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  var txns = [];
  var hashToTxnIndex = {};

  txnConn.onopen = function (ev) {
    var req = {type: "new-transaction", block_chain: "bitcoin"};
    txnConn.send(JSON.stringify(req));
  };

  txnConn.onmessage = function (ev) {
    var x = JSON.parse(ev.data);
    if (x.payload.transaction) {
      // console.dir(x);
      update(x);
    }
  };

  txnConn.onclose = function (ev) {
    txnConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  };

  var blockConn = new WebSocket("wss://ws.chain.com/v2/notifications");


  blockConn.onopen = function (ev) {
    var req = {type: "new-block", block_chain: "bitcoin"};
    blockConn.send(JSON.stringify(req));
  };

  blockConn.onmessage = function (ev) {
    console.log("message");
    var x = JSON.parse(ev.data);
    if (x.payload.block) {
      updateBlock(x);
    }
  };

  blockConn.onclose = function (ev) {
    blockConn = new WebSocket("wss://ws.chain.com/v2/notifications");
  };

  var updateBlock = function(block) {
    var confirmedTxns = block.payload.block.transaction_hashes;
    _.each(confirmedTxns, function(confirmedTxnHash) {
      console.dir("updating " + confirmedTxnHash)
      var idx = hashToTxnIndex[confirmedTxnHash];
      if (idx) {
        txns[idx].payload.transaction.confirmations = 1;
      }
    });
  };

  var getWidthFromSatoshis = function(satoshis) {
    var w = (satoshis / 1e8) * pixelsPerBtc;
    w = (w > maxWidth)? maxWidth : w;
    w = (w < minWidth)? minWidth : w;
    return w;
  }

  d3.select("#unconfirmed-one")
  .append("svg").attr("height", blockHeight).attr("width", 500)
  .append("rect")
  .attr("class", "unconfirmed")
  .attr("x", 0).attr("y", 0)
  .attr("width", pixelsPerBtc).attr("height", blockHeight);

  d3.select("#unconfirmed-one").select("svg")
  .append("text")
  .attr("x", pixelsPerBtc + 6)
  .attr("y", 0)
  .attr("dy", ".9em")
  .attr("class", "smallType")
  .text("1 bitcoin transaction, worth $300");




  d3.select("#confirmed-one")
  .append("div")
  .append("svg").attr("height", blockHeight).attr("width", 500)
  .append("rect")
  .attr("class", "confirmed")
  .attr("x", 0).attr("y", 0)
  .attr("width", pixelsPerBtc).attr("height", blockHeight);

  d3.select("#confirmed-one").select("svg")
  .append("text")
  .attr("x", pixelsPerBtc + 6)
  .attr("y", 0)
  .attr("dy", ".9em")
  .attr("class", "smallType")
  .text("1 bitcoin transaction, mined into a block");

  var svg = d3.select(".viz").append("svg")
              .attr("width", $(window).width())
              .attr("height", 10000);



  var draw = function(data) {
    svg.selectAll("rect")
    .data(data)
    .attr("class", function(d) {
      if (d.payload.transaction.confirmations > 0) {
        return "confirmed";
      } else {
        return "unconfirmed";
      }
    })
    .attr("fill-opacity", function(d, i) {
      if (d.payload.transaction.confirmations > 0) {
        return 1;
      }  else {
        var timeDiff = (new Date()) - d.pushedAt;
        var opacity = 1 - (timeDiff / opacityDecayRate);
        opacity = (opacity < 0)? 0 : opacity;
        return opacity;
      }
    })
    .enter()
    .append("rect")
    .attr("width", function(d, i) {
      return getWidthFromSatoshis(d.payload.transaction.amount);
    })
    .attr("height", blockHeight)
    .attr("x", function(d, i) {
      var width = getWidthFromSatoshis(d.payload.transaction.amount);
      var newColumnLeft = columnLeft + horzSpace + width;
      var value;
      if (newColumnLeft > $(window).width()) {
        value = 0;
        columnLeft = horzSpace + width;
        columnTop += blockHeight + vertSpace;
      } else {
        value = columnLeft;
        columnLeft = newColumnLeft;
      }
      return value;
    })
    .attr("y", function(d, i) {
      return columnTop;
    })
    .attr("fill", enterColor)
    .transition()
    .duration(750)
    .attr("fill", regularColor);
  };

  var _update = function(txn) {
    txn.pushedAt = new Date();
    var listIdx = txns.push(txn);
    hashToTxnIndex[txn.payload.transaction.hash] = listIdx - 1; 
    draw(txns);
  };
  var update = _.throttle(_update, 100); 

  </script>
</body>